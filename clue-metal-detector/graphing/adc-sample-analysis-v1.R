library('stringr')
library('ggplot2')
library('grid')
library('gridExtra')



### A (different) example fo what was executed
###
### >>> [pulse.send(pulses) in range(10)] ; print(mean1000samples_alt2(p1))
### [False]
### 10470.7
### >>> pulses
### array('H', [40000, 500])

### 1000 ADC values from CP 5.0.0 on a CLUE (nRF52840 12 bit) Copied in from REPL 

samples <- c(
     10592, 10624, 10544, 10624, 10656, 10592, 10544, 10560, 10576, 10576,
     10544, 10544, 10640, 10640, 10592, 10480, 10560, 10608, 10592, 10352,
     10592, 10336, 10544, 10528, 10608, 10592, 10544, 10432, 10608, 10496,
     10528, 10640, 10656, 10544, 10656, 10528, 10560, 10624, 10592, 10576,
     10560, 10448, 10112, 10624, 10640, 10624, 10560, 10512, 10496, 10624,
     10512, 10512, 10624, 10752, 10480, 10544, 10544, 10560, 10784, 10480,
     10528, 10640, 10528, 10496, 10704, 10592, 10480, 10560, 10592, 10512,
     10576, 10384, 10624, 10624, 10496, 10512, 10480, 10528, 10608, 10528,
     10576, 10496, 10512, 10480, 10336, 10736, 10544, 10480, 10496, 10416,
     10624, 10544, 10544, 10576, 10576, 10560, 10528, 10528, 10512, 10560,
     10560, 10528, 10560, 10496, 10144, 10496, 10832, 10528, 10560, 10496,
     10560, 10592, 10496, 10432, 10480, 10560, 10480, 10544, 10480, 10544,
     10496, 10512, 10544, 10512, 10528, 10560, 10512, 10544, 10544, 10496,
     10512, 10496, 10368, 10480, 10528, 10480, 10496, 10560, 10496, 10544,
     10496, 10432, 10512, 10544, 10528, 10544, 10560, 10560, 10544, 10592,
     10448, 10400, 10512, 10560, 10528, 10528, 10480, 10496, 10512, 10464,
     10464, 10480, 10464, 10480, 10480, 10496, 10560, 10496, 10464, 10448,
     10448, 10528, 10496, 10496, 10464, 10480, 10560, 10496, 10496, 10640,
     10560, 10512, 10480, 10512, 10496, 10480, 10480, 10544, 10464, 10480,
     10624, 10272, 10528, 10496, 10464, 10800, 10496, 10528, 10448, 10560,
     10512, 10496, 10464, 10528, 10480, 10576, 10480, 10560, 10480, 10576,
     10480, 10512, 10608, 10448, 10496, 10480, 10512, 10752, 10480, 10480,
     10480, 10480, 10480, 10464, 10480, 10544, 10464, 10432, 10608, 10384,
     10368, 10512, 10512, 10480, 10528, 10272, 10336, 10448, 10480, 10528,
     10416, 10464, 10448, 10416, 10480, 10576, 10512, 10496, 10512, 10528,
     10464, 10432, 10464, 10512, 10432, 10544, 10432, 10448, 10480, 10448,
     10432, 10464, 10352, 10432, 10480, 10464, 10528, 10480, 10416, 10480,
     10480, 10480, 10496, 10416, 10480, 10288, 10512, 10448, 10448, 10464,
     10304, 10384, 10480, 10448, 10480, 10624, 10496, 10448, 10368, 10496,
     10560, 10464, 10528, 10336, 10416, 10496, 10416, 10416, 10496, 10432,
     10352, 10416, 10496, 10496, 10432, 10560, 10416, 10528, 10320, 10464,
     10512, 10496, 10496, 10400, 10416, 10496, 10544, 10320, 10304, 10496,
     10352, 10400, 10512, 10352, 10464, 10384, 10400, 10496, 10480, 10416,
     10464, 10512, 10528, 10352, 10448, 10416, 10416, 10480, 10496, 10560,
     10416, 10400, 10416, 10448, 10480, 10320, 10400, 10720, 10416, 10416,
     10464, 10448, 10432, 10464, 10448, 10384, 10416, 10432, 10416, 10432,
     10352, 10416, 10352, 10224, 10416, 10464, 10464, 10496, 10416, 10128,
     10432, 10720, 10480, 10416, 10448, 10416, 10464, 10368, 10432, 10480,
     10432, 10464, 10496, 10480, 10464, 10432, 10352, 10400, 10496, 10416,
     10464, 10448, 10368, 10400, 10496, 10224, 10400, 10480, 10464, 10432,
     10448, 10416, 10416, 10496, 10496, 10464, 10416, 10400, 10368, 10384,
     10432, 9968, 10192, 10416, 10400, 10480, 10512, 10480, 10432, 10432,
     10480, 10352, 10432, 10416, 10512, 10384, 10176, 10752, 10528, 10192,
     10352, 10432, 10384, 10480, 10448, 10368, 10160, 10368, 10448, 10528,
     10448, 10352, 10320, 10416, 10400, 10384, 10336, 10432, 10368, 10384,
     10432, 10432, 10448, 10352, 10384, 10416, 10496, 10496, 10496, 10256,
     10080, 10624, 10448, 10384, 10336, 10448, 10400, 10432, 10400, 10432,
     10416, 10352, 10368, 10416, 10224, 10352, 10352, 10432, 10336, 10432,
     10288, 10464, 10432, 10240, 10432, 10352, 10400, 10432, 10416, 10464,
     10288, 10432, 10464, 10352, 10416, 10384, 10416, 10432, 10448, 10448,
     10448, 10656, 10480, 10400, 10432, 10432, 10416, 10432, 10480, 10464,
     10352, 10432, 10464, 10384, 10528, 10432, 10480, 10496, 10416, 10496,
     10416, 10496, 10368, 10416, 10800, 10400, 10352, 10576, 10384, 10432,
     10448, 10448, 10448, 10432, 10496, 10416, 10496, 10320, 10384, 10480,
     10416, 10336, 10416, 10336, 10352, 10400, 10368, 10288, 9792, 10320,
     10368, 10352, 10400, 10320, 10432, 10160, 10384, 10432, 10432, 10368,
     10432, 10352, 10304, 10416, 10432, 10368, 10352, 10432, 10352, 10496,
     10352, 10384, 10464, 10432, 10400, 10400, 10416, 10336, 10432, 10224,
     10592, 10368, 10432, 10352, 10384, 10368, 10432, 10432, 10416, 10352,
     10272, 10416, 10384, 10448, 10368, 10352, 10304, 10240, 10400, 10528,
     10416, 10352, 10368, 10416, 10448, 10464, 10368, 10256, 10400, 10400,
     10352, 10368, 10432, 10352, 10432, 10448, 10368, 10336, 10352, 10432,
     10448, 10544, 10368, 10496, 10384, 10240, 10368, 10256, 10352, 10288,
     10320, 10304, 10384, 10352, 10400, 10432, 10384, 10384, 10352, 10352,
     10368, 10384, 10352, 10368, 10752, 10368, 10368, 10416, 10336, 10224,
     10400, 10400, 10432, 10416, 10496, 10432, 10432, 10384, 10304, 10336,
     10336, 10368, 10384, 10384, 10368, 10496, 10304, 10384, 10384, 10384,
     10352, 10304, 10432, 10352, 10272, 10352, 10416, 10368, 10512, 10336,
     10432, 10304, 10336, 10336, 10368, 10368, 10368, 10320, 10368, 10352,
     10400, 10304, 10352, 9968, 10352, 10288, 10272, 10368, 10320, 10464,
     10368, 10320, 10336, 10432, 10656, 10368, 10368, 10336, 10384, 10336,
     10336, 10352, 10336, 10224, 10368, 10384, 10336, 10336, 10336, 10320,
     10384, 10352, 10368, 10320, 10272, 10224, 10352, 10368, 10320, 10320,
     10352, 10304, 10352, 10352, 10224, 10352, 10288, 10288, 10416, 10352,
     10432, 10368, 10304, 10112, 10288, 10352, 10400, 10320, 10352, 10352,
     10320, 10208, 10512, 10288, 10208, 10320, 10272, 10304, 10368, 10352,
     10368, 10304, 10352, 10336, 10288, 10272, 10336, 10368, 10288, 10560,
     10240, 10320, 10464, 10432, 10304, 10288, 10304, 10256, 10304, 10320,
     10368, 10272, 10368, 10256, 10224, 10352, 10304, 10256, 10320, 10288,
     10336, 10288, 10320, 10224, 10320, 10320, 10400, 10368, 10304, 10384,
     10368, 10320, 10320, 10304, 10288, 10368, 10336, 10416, 10320, 10304,
     10336, 10288, 10304, 10352, 10352, 10304, 10256, 10352, 10240, 10288,
     10304, 10256, 10304, 10400, 10288, 10384, 10272, 10320, 10336, 10224,
     10368, 10256, 10368, 10304, 10272, 10288, 10432, 10352, 10288, 10336,
     10288, 10368, 10304, 9552, 10320, 10336, 10288, 10384, 10320, 10272,
     10320, 10368, 10256, 10368, 10336, 10368, 10288, 10352, 10352, 10288,
     10512, 10320, 10320, 10352, 10336, 10272, 10160, 10336, 10288, 10272,
     10336, 10288, 10416, 10208, 10304, 10272, 10320, 10288, 10336, 10400,
     10304, 10368, 10352, 10336, 10208, 10288, 10352, 10240, 10336, 10352,
     10288, 10288, 10288, 10288, 10352, 10272, 10272, 10224, 10176, 10224,
     10224, 10224, 10272, 10384, 10368, 10208, 10320, 10320, 10320, 10336,
     10304, 9696, 10304, 10400, 10304, 10304, 10256, 10256, 10288, 10272,
     10304, 10272, 10240, 10320, 10304, 10240, 10208, 10272, 10208, 10336,
     10320, 10320, 10224, 10208, 10224, 10320, 10288, 10256, 10208, 10320,
     10240, 10224, 10224, 10352, 10384, 10336, 10336, 10304, 10304, 10256,
     10304, 10304, 10256, 10368, 10288, 10288, 10288, 10304, 10368, 10240,
     10272, 10304, 10240, 10320, 10160, 10320, 10240, 10304, 10208, 10160,
     10320, 10256, 10224, 10288, 10224, 10224, 10256, 10304, 10208, 10240,
     10304, 10288, 10368, 10336, 10256, 10176, 10304, 10288, 10240, 10224,
     10272, 10224, 10288, 10256, 10320, 10224, 10352, 10272, 10288, 10224)

sample_period = 0.046

ref_voltage <- 3.3

rc_value <- 1e6 * 2.2 * 1e-6

delay <- 0.005

samples_df <- data.frame(voltage=samples*ref_voltage/65535.0,
                         time=seq(0.0, sample_period, length.out=length(samples)))





model_exp <- nls(voltage ~ I(a * exp((-time - delay) / b)),
                             data=samples_df, start=list(a=samples_df$voltage[1],
                                                        b=1*2.2))

model_poly1_pass1 <- nls(voltage ~ I(a * time + b),
                         data=samples_df)

samples_df$res_poly1_pass1 <- residuals(model_poly1_pass1)

### There's a handful around 50ms out
outlier_s <- 0.050

### Calculate some weights to reduce effect of outliers on nls (s for squares)
### take the distance away from the outlier_s based on first fitted line
### and cap that, scale to 4.99 then cap those values at 4.0
samples_df$w1 <- pmin((outlier_s - pmin(outlier_s,
                                        abs(samples_df$res_poly1_pass1))) * 4.99/outlier_s,
                      4.0)

model_poly1_pass2 <- nls(voltage ~ I(a * time + b),
                         data=samples_df,
                         weights=samples_df$w1)


### plot graph with points, curve, both lines.


### plot same graph and zoom in on vertical

### TODO - colours are terrible
### yellow points are barely visible
### TODO clean-up legend
### TODO add annotation bottom left with
###    mean, mean(fitted exp()), mean(fitted line), mean(fitted line (weighted))

### Do i care about Q-Q?

g1 <- ggplot(samples_df, aes(x=time*1000.0)) +
  ggtitle("P1 pad voltage during slow capacitor discharge") +
  theme_light(base_size=28) +
  theme(plot.title=element_text(hjust=0.5, size=34),
        legend.position="top", legend.title=element_blank(),
        legend.spacing.x = unit(0.5, 'char'),
        panel.grid.minor.y=element_blank()) +
  labs(x="approximate time (ms)", y="voltage (V)") +
  geom_point(aes(y=voltage,
                 color=cut(samples_df$w1, c(0, 1, 2, 3, 4)),
                 size=5 - samples_df$w1)) +
  scale_color_manual(values=c("(0,1]" ="red",
                              "(1,2]" = "orangered",
                              "(2,3]" = "orange",
                              "(3,4]" = "black")) +
  geom_line(aes(y=predict(model_exp, list(x=x))), colour='grey', lwd=3) +
  geom_line(aes(y=predict(model_poly1_pass1, list(x=x))), colour="purple", linetype="dashed", lwd=0.75) +
  geom_line(aes(y=predict(model_poly1_pass2, list(x=x))), colour="green", linetype="twodash", lwd=0.75)


# this shows the line a bit more clearly - also shows the discrete nature of samples
headroom <- 0.000  ### 0mV
g2 <- g1 + coord_cartesian(ylim=c(min(predict(model_poly1_pass2, list(x=samples_df$time))) - headroom,
                                  max(predict(model_poly1_pass2, list(x=samples_df$time))) + headroom))
  
#g1


filebase <- ""


filename <- "graph1"
### Save as 1600x1200 (4:3) png
ggsave(paste(filebase, filename, ".png", sep=""),
       g1,
       dpi=100, height=12, width=16, units="in")



filename <- "graph2"
### Save as 1600x1200 (4:3) png
ggsave(paste(filebase, filename, ".png", sep=""),
       g2,
       dpi=100, height=12, width=16, units="in")

