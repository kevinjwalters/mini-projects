library('stringr')
library('ggplot2')
library('grid')
library('gridExtra')



### A (different) example fo what was executed
###
### >>> [pulse.send(pulses) in range(10)] ; print(mean1000samples_alt2(p1))
### [False]
### 10470.7
### >>> pulses
### array('H', [40000, 500])

### 1000 ADC values from CP 5.0.0 on a CLUE (nRF52840 12 bit) Copied in from REPL 

### samples 1 2.2uF non-continuous

samples1 <- c(
     10592, 10624, 10544, 10624, 10656, 10592, 10544, 10560, 10576, 10576,
     10544, 10544, 10640, 10640, 10592, 10480, 10560, 10608, 10592, 10352,
     10592, 10336, 10544, 10528, 10608, 10592, 10544, 10432, 10608, 10496,
     10528, 10640, 10656, 10544, 10656, 10528, 10560, 10624, 10592, 10576,
     10560, 10448, 10112, 10624, 10640, 10624, 10560, 10512, 10496, 10624,
     10512, 10512, 10624, 10752, 10480, 10544, 10544, 10560, 10784, 10480,
     10528, 10640, 10528, 10496, 10704, 10592, 10480, 10560, 10592, 10512,
     10576, 10384, 10624, 10624, 10496, 10512, 10480, 10528, 10608, 10528,
     10576, 10496, 10512, 10480, 10336, 10736, 10544, 10480, 10496, 10416,
     10624, 10544, 10544, 10576, 10576, 10560, 10528, 10528, 10512, 10560,
     10560, 10528, 10560, 10496, 10144, 10496, 10832, 10528, 10560, 10496,
     10560, 10592, 10496, 10432, 10480, 10560, 10480, 10544, 10480, 10544,
     10496, 10512, 10544, 10512, 10528, 10560, 10512, 10544, 10544, 10496,
     10512, 10496, 10368, 10480, 10528, 10480, 10496, 10560, 10496, 10544,
     10496, 10432, 10512, 10544, 10528, 10544, 10560, 10560, 10544, 10592,
     10448, 10400, 10512, 10560, 10528, 10528, 10480, 10496, 10512, 10464,
     10464, 10480, 10464, 10480, 10480, 10496, 10560, 10496, 10464, 10448,
     10448, 10528, 10496, 10496, 10464, 10480, 10560, 10496, 10496, 10640,
     10560, 10512, 10480, 10512, 10496, 10480, 10480, 10544, 10464, 10480,
     10624, 10272, 10528, 10496, 10464, 10800, 10496, 10528, 10448, 10560,
     10512, 10496, 10464, 10528, 10480, 10576, 10480, 10560, 10480, 10576,
     10480, 10512, 10608, 10448, 10496, 10480, 10512, 10752, 10480, 10480,
     10480, 10480, 10480, 10464, 10480, 10544, 10464, 10432, 10608, 10384,
     10368, 10512, 10512, 10480, 10528, 10272, 10336, 10448, 10480, 10528,
     10416, 10464, 10448, 10416, 10480, 10576, 10512, 10496, 10512, 10528,
     10464, 10432, 10464, 10512, 10432, 10544, 10432, 10448, 10480, 10448,
     10432, 10464, 10352, 10432, 10480, 10464, 10528, 10480, 10416, 10480,
     10480, 10480, 10496, 10416, 10480, 10288, 10512, 10448, 10448, 10464,
     10304, 10384, 10480, 10448, 10480, 10624, 10496, 10448, 10368, 10496,
     10560, 10464, 10528, 10336, 10416, 10496, 10416, 10416, 10496, 10432,
     10352, 10416, 10496, 10496, 10432, 10560, 10416, 10528, 10320, 10464,
     10512, 10496, 10496, 10400, 10416, 10496, 10544, 10320, 10304, 10496,
     10352, 10400, 10512, 10352, 10464, 10384, 10400, 10496, 10480, 10416,
     10464, 10512, 10528, 10352, 10448, 10416, 10416, 10480, 10496, 10560,
     10416, 10400, 10416, 10448, 10480, 10320, 10400, 10720, 10416, 10416,
     10464, 10448, 10432, 10464, 10448, 10384, 10416, 10432, 10416, 10432,
     10352, 10416, 10352, 10224, 10416, 10464, 10464, 10496, 10416, 10128,
     10432, 10720, 10480, 10416, 10448, 10416, 10464, 10368, 10432, 10480,
     10432, 10464, 10496, 10480, 10464, 10432, 10352, 10400, 10496, 10416,
     10464, 10448, 10368, 10400, 10496, 10224, 10400, 10480, 10464, 10432,
     10448, 10416, 10416, 10496, 10496, 10464, 10416, 10400, 10368, 10384,
     10432, 9968, 10192, 10416, 10400, 10480, 10512, 10480, 10432, 10432,
     10480, 10352, 10432, 10416, 10512, 10384, 10176, 10752, 10528, 10192,
     10352, 10432, 10384, 10480, 10448, 10368, 10160, 10368, 10448, 10528,
     10448, 10352, 10320, 10416, 10400, 10384, 10336, 10432, 10368, 10384,
     10432, 10432, 10448, 10352, 10384, 10416, 10496, 10496, 10496, 10256,
     10080, 10624, 10448, 10384, 10336, 10448, 10400, 10432, 10400, 10432,
     10416, 10352, 10368, 10416, 10224, 10352, 10352, 10432, 10336, 10432,
     10288, 10464, 10432, 10240, 10432, 10352, 10400, 10432, 10416, 10464,
     10288, 10432, 10464, 10352, 10416, 10384, 10416, 10432, 10448, 10448,
     10448, 10656, 10480, 10400, 10432, 10432, 10416, 10432, 10480, 10464,
     10352, 10432, 10464, 10384, 10528, 10432, 10480, 10496, 10416, 10496,
     10416, 10496, 10368, 10416, 10800, 10400, 10352, 10576, 10384, 10432,
     10448, 10448, 10448, 10432, 10496, 10416, 10496, 10320, 10384, 10480,
     10416, 10336, 10416, 10336, 10352, 10400, 10368, 10288, 9792, 10320,
     10368, 10352, 10400, 10320, 10432, 10160, 10384, 10432, 10432, 10368,
     10432, 10352, 10304, 10416, 10432, 10368, 10352, 10432, 10352, 10496,
     10352, 10384, 10464, 10432, 10400, 10400, 10416, 10336, 10432, 10224,
     10592, 10368, 10432, 10352, 10384, 10368, 10432, 10432, 10416, 10352,
     10272, 10416, 10384, 10448, 10368, 10352, 10304, 10240, 10400, 10528,
     10416, 10352, 10368, 10416, 10448, 10464, 10368, 10256, 10400, 10400,
     10352, 10368, 10432, 10352, 10432, 10448, 10368, 10336, 10352, 10432,
     10448, 10544, 10368, 10496, 10384, 10240, 10368, 10256, 10352, 10288,
     10320, 10304, 10384, 10352, 10400, 10432, 10384, 10384, 10352, 10352,
     10368, 10384, 10352, 10368, 10752, 10368, 10368, 10416, 10336, 10224,
     10400, 10400, 10432, 10416, 10496, 10432, 10432, 10384, 10304, 10336,
     10336, 10368, 10384, 10384, 10368, 10496, 10304, 10384, 10384, 10384,
     10352, 10304, 10432, 10352, 10272, 10352, 10416, 10368, 10512, 10336,
     10432, 10304, 10336, 10336, 10368, 10368, 10368, 10320, 10368, 10352,
     10400, 10304, 10352, 9968, 10352, 10288, 10272, 10368, 10320, 10464,
     10368, 10320, 10336, 10432, 10656, 10368, 10368, 10336, 10384, 10336,
     10336, 10352, 10336, 10224, 10368, 10384, 10336, 10336, 10336, 10320,
     10384, 10352, 10368, 10320, 10272, 10224, 10352, 10368, 10320, 10320,
     10352, 10304, 10352, 10352, 10224, 10352, 10288, 10288, 10416, 10352,
     10432, 10368, 10304, 10112, 10288, 10352, 10400, 10320, 10352, 10352,
     10320, 10208, 10512, 10288, 10208, 10320, 10272, 10304, 10368, 10352,
     10368, 10304, 10352, 10336, 10288, 10272, 10336, 10368, 10288, 10560,
     10240, 10320, 10464, 10432, 10304, 10288, 10304, 10256, 10304, 10320,
     10368, 10272, 10368, 10256, 10224, 10352, 10304, 10256, 10320, 10288,
     10336, 10288, 10320, 10224, 10320, 10320, 10400, 10368, 10304, 10384,
     10368, 10320, 10320, 10304, 10288, 10368, 10336, 10416, 10320, 10304,
     10336, 10288, 10304, 10352, 10352, 10304, 10256, 10352, 10240, 10288,
     10304, 10256, 10304, 10400, 10288, 10384, 10272, 10320, 10336, 10224,
     10368, 10256, 10368, 10304, 10272, 10288, 10432, 10352, 10288, 10336,
     10288, 10368, 10304, 9552, 10320, 10336, 10288, 10384, 10320, 10272,
     10320, 10368, 10256, 10368, 10336, 10368, 10288, 10352, 10352, 10288,
     10512, 10320, 10320, 10352, 10336, 10272, 10160, 10336, 10288, 10272,
     10336, 10288, 10416, 10208, 10304, 10272, 10320, 10288, 10336, 10400,
     10304, 10368, 10352, 10336, 10208, 10288, 10352, 10240, 10336, 10352,
     10288, 10288, 10288, 10288, 10352, 10272, 10272, 10224, 10176, 10224,
     10224, 10224, 10272, 10384, 10368, 10208, 10320, 10320, 10320, 10336,
     10304, 9696, 10304, 10400, 10304, 10304, 10256, 10256, 10288, 10272,
     10304, 10272, 10240, 10320, 10304, 10240, 10208, 10272, 10208, 10336,
     10320, 10320, 10224, 10208, 10224, 10320, 10288, 10256, 10208, 10320,
     10240, 10224, 10224, 10352, 10384, 10336, 10336, 10304, 10304, 10256,
     10304, 10304, 10256, 10368, 10288, 10288, 10288, 10304, 10368, 10240,
     10272, 10304, 10240, 10320, 10160, 10320, 10240, 10304, 10208, 10160,
     10320, 10256, 10224, 10288, 10224, 10224, 10256, 10304, 10208, 10240,
     10304, 10288, 10368, 10336, 10256, 10176, 10304, 10288, 10240, 10224,
     10272, 10224, 10288, 10256, 10320, 10224, 10352, 10272, 10288, 10224)


### samples2 is 0.1uF ceramic/mylar with continuous pulsing at 400kHz 55000 duty
### 

### >>> discard = [print("    ", ", ".join(map(str,sample_store_list[x:x+10])), end=",\n") for x in range(0,1000,10)]

samples2 <- c(
  23808, 23712, 23680, 23696, 23696, 23712, 23696, 23712, 23696, 23648,
  23472, 23712, 23520, 23616, 23744, 23568, 23680, 23200, 23680, 23744,
  23712, 23760, 23152, 24208, 23984, 23456, 23280, 23664, 24256, 24528,
  23664, 23600, 23696, 23616, 23712, 23712, 24128, 23680, 23744, 23584,
  23936, 23600, 23552, 23936, 23648, 23840, 24448, 22928, 23664, 23360,
  24304, 23568, 23744, 23616, 23632, 23664, 23632, 23664, 23664, 23664,
  23776, 23776, 23744, 23424, 24128, 23872, 23552, 23600, 23728, 23696,
  23712, 23520, 23536, 23872, 23584, 23664, 23936, 23632, 23744, 23344,
  23680, 23712, 23664, 23744, 23664, 23600, 23600, 23680, 23648, 23856,
  23664, 23616, 23840, 23248, 24000, 23696, 23712, 23632, 24352, 23664,
  23664, 23776, 23616, 23584, 23600, 23712, 23664, 23632, 23888, 23856,
  23472, 23568, 23600, 23744, 23664, 23728, 23664, 23728, 23584, 23600,
  23872, 23696, 23440, 23568, 23504, 23712, 24336, 23744, 23712, 23760,
  23600, 23712, 23696, 23616, 23776, 23680, 23600, 23712, 23664, 23728,
  23680, 23712, 23488, 23616, 22864, 23696, 23680, 23584, 23680, 23632,
  23808, 23776, 23552, 23664, 23680, 23744, 23680, 23664, 23488, 23760,
  23744, 23808, 23536, 23728, 23712, 23408, 23648, 23744, 23712, 23728,
  23536, 23680, 23520, 23680, 23600, 23600, 23712, 23760, 23520, 23664,
  23664, 23616, 23744, 23744, 23600, 23712, 23488, 23744, 23728, 23088,
  23616, 23600, 23664, 24400, 23664, 23936, 23776, 23472, 23872, 24112,
  23472, 23680, 23728, 23664, 23536, 23664, 23568, 23664, 23680, 23552,
  23648, 23712, 23584, 23552, 23584, 23696, 23728, 23680, 23616, 23664,
  23600, 23824, 23504, 23680, 23360, 23232, 23680, 23904, 24320, 23744,
  23664, 23664, 23728, 23648, 23648, 23680, 23648, 23664, 23616, 23696,
  23696, 23536, 23760, 23648, 23648, 23776, 23696, 23792, 23536, 23504,
  23904, 23552, 23664, 24272, 23456, 23472, 23168, 23680, 23712, 23696,
  23568, 23552, 23632, 23664, 23648, 23504, 23712, 24016, 23888, 23824,
  23744, 23632, 23664, 23696, 23680, 23744, 23664, 23600, 23744, 23456,
  23552, 23600, 23664, 23808, 23664, 23664, 23376, 23728, 23440, 23728,
  23424, 23680, 24320, 23616, 23824, 23520, 23536, 23584, 23520, 23680,
  23680, 23600, 23840, 23680, 23744, 23312, 23168, 23536, 23264, 23712,
  23712, 23648, 23120, 23664, 23584, 23664, 23600, 23520, 23696, 23696,
  22432, 23680, 23728, 23456, 23648, 23664, 23776, 23600, 23664, 23632,
  23712, 22592, 23568, 23344, 23632, 24064, 23616, 22880, 23968, 23568,
  23008, 23792, 23488, 24240, 23648, 23680, 23504, 23712, 23808, 23552,
  23776, 23600, 23456, 23408, 24352, 23040, 23744, 23552, 23760, 23680,
  23600, 23664, 23632, 23264, 23680, 23648, 23296, 23520, 23840, 23344,
  23632, 23680, 23664, 23712, 23728, 23488, 23632, 23648, 23696, 23664,
  23616, 23696, 23744, 23616, 23632, 23664, 23600, 23680, 23584, 23744,
  23504, 23824, 23600, 23632, 23536, 23680, 23712, 23376, 24096, 23600,
  23456, 23728, 23504, 23744, 23632, 23712, 23664, 23600, 23664, 23808,
  23504, 23648, 23760, 23968, 23616, 24000, 23840, 23680, 23696, 23808,
  24208, 23600, 23600, 23680, 23888, 23312, 23488, 23728, 23456, 23744,
  23648, 23696, 23648, 23680, 23728, 23552, 23680, 23536, 23808, 23632,
  23664, 23648, 23680, 23920, 23648, 23152, 23712, 23280, 23632, 23712,
  23664, 23664, 23664, 23728, 23808, 23664, 23712, 23600, 23744, 23664,
  23664, 23760, 23664, 23552, 23680, 23680, 23680, 22768, 23680, 23808,
  23600, 24272, 23600, 23344, 23680, 23968, 23584, 23664, 23536, 23552,
  23872, 23664, 23824, 23968, 24064, 23632, 23632, 23712, 23568, 23728,
  23744, 23600, 23632, 23888, 23232, 23664, 23632, 23744, 23648, 23344,
  23616, 23632, 23712, 23744, 23600, 23664, 23552, 23712, 23680, 23664,
  23664, 23680, 23696, 23760, 23760, 23552, 23744, 23600, 23488, 23376,
  23600, 24096, 23712, 23584, 23616, 23744, 23664, 23584, 23600, 23840,
  23760, 23744, 23664, 23568, 23728, 23616, 23648, 23680, 23280, 23744,
  23632, 23536, 23760, 23616, 23664, 23648, 23696, 23680, 23616, 23616,
  23488, 23648, 24112, 23200, 23648, 23840, 23520, 23712, 23600, 23552,
  23664, 23664, 23728, 23664, 23712, 23680, 23712, 23520, 23584, 23680,
  23696, 23680, 23632, 23680, 23664, 23536, 23584, 23680, 23568, 23472,
  23680, 23680, 23664, 23680, 23648, 23616, 23568, 23712, 23408, 23600,
  23696, 23712, 24080, 23552, 23152, 23728, 23680, 23824, 23696, 23664,
  23488, 23760, 23808, 23472, 23552, 23616, 23680, 23760, 23696, 23408,
  23904, 23792, 23360, 23408, 23664, 23808, 23648, 23408, 23760, 23568,
  23488, 23632, 23728, 23680, 23632, 23664, 23536, 23760, 23744, 23328,
  23744, 23552, 24448, 23536, 23488, 23840, 21808, 24176, 23696, 23424,
  23696, 23104, 23504, 23728, 23696, 23744, 23728, 23680, 23648, 23632,
  23872, 23520, 23520, 23824, 23648, 24000, 23680, 24416, 23680, 23520,
  23536, 23648, 23680, 23680, 23680, 23680, 23680, 23536, 23552, 23744,
  23600, 23632, 23536, 23792, 23680, 23680, 23664, 23744, 23472, 23648,
  23664, 23680, 23712, 24128, 23680, 23488, 23552, 23664, 23664, 23696,
  23664, 23232, 23456, 23344, 23968, 23504, 23584, 23664, 23664, 23968,
  22976, 23632, 23648, 23504, 23536, 23664, 23680, 23744, 23664, 23728,
  23664, 23520, 23536, 23792, 23792, 23680, 23600, 23392, 23616, 23664,
  24112, 23472, 23456, 23808, 23680, 23696, 23664, 23664, 23680, 23520,
  23536, 23248, 23664, 23648, 23552, 23392, 23680, 23840, 23648, 24000,
  23680, 23600, 23664, 23664, 23680, 23680, 23648, 23136, 23584, 23616,
  24000, 23936, 23648, 23728, 23728, 23536, 23536, 23600, 23712, 23728,
  23664, 23680, 23712, 23760, 23616, 23472, 23520, 23600, 23680, 23856,
  23664, 23888, 24608, 23552, 23552, 23600, 23664, 23696, 23680, 24208,
  23616, 23472, 23600, 24288, 24272, 23680, 23696, 23680, 23632, 23136,
  23696, 23616, 23568, 23696, 23680, 23648, 23616, 23712, 23744, 23216,
  23552, 23296, 23616, 23856, 23680, 23712, 23664, 23536, 23536, 23568,
  23536, 23728, 23712, 23664, 23680, 23648, 23632, 23568, 23536, 23664,
  23696, 23776, 23600, 23664, 23648, 23232, 23552, 23616, 23616, 23648,
  23552, 24336, 23632, 23680, 23328, 23536, 23344, 24144, 23648, 24096,
  23680, 23536, 23648, 23744, 23552, 23760, 23664, 23616, 23632, 23632,
  23680, 23552, 23616, 23696, 23616, 23712, 23648, 23680, 23440, 23632,
  23840, 23488, 23584, 23344, 23664, 23552, 23632, 23664, 23824, 23488,
  23584, 23712, 23680, 23648, 23664, 23616, 23712, 22336, 23616, 23632,
  23760, 23680, 23712, 23312, 23728, 23680, 23744, 23200, 23536, 23856,
  23296, 22944, 23632, 23792, 23632, 23520, 23504, 23664, 23632, 23648,
  23616, 23664, 23680, 23584, 23616, 23504, 23168, 23616, 23680, 22608,
  23664, 23632, 23632, 23552, 23568, 23680, 23616, 23680, 23680, 23664,
  23248, 23536, 23616, 23424, 23728, 23600, 23744, 23728, 23808, 23472,
  23264, 23488, 23088, 23664, 22912, 24000, 23408, 23680, 23616, 23472,
  23472, 23696, 23568, 23664, 23696, 23792, 23712, 23856, 23536, 23888,
  23536, 23920, 23568, 23792, 23600, 23680, 23648, 23664, 23536, 23664,
  23744, 23648, 23616, 23600, 23664, 23536, 23536, 23728, 23648, 23664,
  23808, 23616, 23408, 23920, 23712, 23376, 23552, 23808, 23648, 23696,
  23600, 23328, 23536, 23552, 23280, 23728, 23776, 23536, 23712, 23568,
  23600, 23264, 23488, 23680, 23664, 23600, 23712, 23680, 23616, 23648
)

### same as samples2

samples3 <- c(
  23664, 23648, 23680, 23568, 23472, 23552, 23808, 23680, 23648, 23664,
  23712, 23440, 23232, 24048, 23712, 23696, 23696, 23600, 23664, 23664,
  23664, 23808, 23568, 23536, 23744, 23312, 23840, 23680, 23712, 23664,
  23680, 23648, 23664, 23664, 23584, 23664, 23744, 23712, 23744, 23536,
  23888, 23328, 23344, 23632, 23584, 23744, 23632, 23712, 23824, 23584,
  23664, 23632, 23504, 23584, 23712, 23680, 23504, 23600, 23600, 23648,
  23408, 23360, 23680, 23648, 22080, 23664, 23600, 23712, 23664, 23680,
  23648, 23696, 23584, 23584, 23680, 23664, 23792, 23648, 22912, 23648,
  23488, 23488, 23616, 23648, 23520, 23632, 23664, 23648, 23936, 23616,
  23680, 23392, 23904, 23680, 23616, 23616, 23600, 23744, 23712, 23488,
  23600, 23872, 23936, 23664, 23936, 23712, 23760, 23504, 23712, 23568,
  23680, 23616, 23600, 23632, 23648, 23648, 23760, 23616, 23920, 23680,
  23680, 23760, 23744, 23648, 23840, 23584, 23584, 23856, 23376, 23424,
  23648, 23920, 23696, 23792, 23680, 23552, 23760, 23520, 23552, 23728,
  23680, 23712, 23680, 23632, 23696, 23696, 23568, 23712, 23616, 23696,
  23680, 23600, 23648, 23632, 23616, 23728, 24176, 23792, 23472, 24160,
  23680, 23488, 23664, 23744, 23696, 23456, 23344, 23600, 23632, 23632,
  23616, 23904, 23664, 23536, 23504, 23680, 23648, 23648, 23632, 23728,
  23696, 23632, 23520, 23392, 23664, 23744, 23680, 23648, 23664, 23744,
  23536, 23536, 22640, 23104, 23664, 23632, 23680, 23344, 23456, 23376,
  23680, 23664, 23808, 23616, 23552, 23632, 23744, 23776, 23600, 23584,
  23600, 23664, 23840, 23664, 22992, 23536, 23552, 23552, 23584, 23632,
  23584, 23712, 23520, 23792, 23712, 23712, 23584, 23296, 23776, 23616,
  23280, 23664, 23568, 23696, 23648, 23552, 23680, 23680, 23648, 24192,
  24352, 23776, 23664, 23584, 23792, 23632, 23600, 23680, 23680, 23824,
  23712, 23552, 23744, 23728, 23536, 23200, 23616, 23728, 23504, 23536,
  23648, 23808, 23552, 23680, 23696, 23648, 23168, 23568, 23744, 23600,
  23648, 23632, 23616, 23584, 24272, 23584, 23616, 23696, 23568, 23680,
  23840, 23744, 23632, 24240, 23616, 23776, 23568, 23680, 23744, 23648,
  23648, 23648, 23680, 23680, 23696, 23712, 23696, 23568, 23728, 23648,
  23616, 23728, 23888, 23616, 23696, 23936, 23616, 24064, 23648, 23536,
  23504, 23648, 23584, 23648, 23616, 23648, 23680, 23936, 23584, 23680,
  23568, 24368, 23504, 23664, 23488, 24000, 23904, 23536, 23552, 23696,
  23312, 23584, 23744, 23600, 23696, 23648, 23552, 23584, 23680, 23536,
  23696, 23648, 23552, 23728, 23536, 23616, 23664, 23872, 23600, 24080,
  23200, 23936, 23360, 23536, 23616, 23776, 23696, 23632, 23632, 23680,
  23648, 23680, 23712, 23152, 23280, 23632, 23568, 23504, 23664, 23680,
  23712, 23632, 23568, 23664, 23568, 23664, 23632, 23664, 23680, 23616,
  23664, 23344, 23552, 23232, 23504, 23680, 23600, 23664, 23552, 23520,
  23552, 23600, 23072, 23712, 23648, 23648, 23744, 23536, 23712, 23568,
  23888, 23744, 23552, 24176, 23808, 23952, 22544, 23440, 23680, 23616,
  23712, 22880, 23680, 23248, 23744, 23520, 23632, 23632, 23664, 23680,
  23600, 23664, 23760, 23584, 23488, 24304, 22896, 23744, 23632, 23680,
  23680, 23648, 23696, 23744, 23856, 23568, 23600, 23648, 23632, 23648,
  23744, 23600, 23792, 24000, 23488, 23616, 23680, 23632, 23952, 23648,
  23472, 23776, 23552, 23632, 23696, 23664, 23552, 23648, 23680, 23680,
  23520, 23648, 23696, 23648, 23664, 23616, 23680, 23584, 23536, 23664,
  23552, 23728, 23664, 23856, 23616, 23744, 23664, 23568, 23664, 23712,
  23808, 23712, 23600, 23712, 23504, 23280, 23920, 23712, 23616, 23680,
  23696, 23296, 23504, 23456, 23568, 23568, 23552, 23664, 23600, 23632,
  23600, 23648, 23776, 23536, 23440, 23536, 23680, 23744, 23648, 23760,
  23680, 23744, 23520, 23648, 23632, 23680, 23744, 23680, 23600, 23760,
  24240, 23568, 23280, 23728, 23712, 23680, 23648, 23728, 23696, 23616,
  23664, 23632, 23680, 23328, 23712, 23840, 23872, 23200, 23728, 23632,
  23664, 23680, 24416, 23520, 23664, 23712, 23696, 23536, 23664, 23888,
  23632, 23072, 23696, 23376, 23712, 23648, 23424, 23552, 23744, 23664,
  23616, 23680, 23600, 23664, 23680, 23584, 23632, 23632, 23872, 23632,
  24192, 23632, 23680, 23472, 23728, 23664, 23552, 23680, 23712, 23680,
  23648, 23664, 23552, 23536, 23152, 23520, 23600, 23600, 23696, 23584,
  23472, 23776, 23280, 24048, 23568, 23584, 23616, 23680, 23680, 23728,
  23552, 23536, 23728, 23680, 23600, 23648, 23600, 23568, 23392, 23648,
  23536, 23776, 23616, 23552, 23648, 23584, 23680, 23648, 23536, 23728,
  23584, 23616, 23696, 23744, 23600, 23536, 23280, 23968, 23552, 23104,
  23632, 23840, 23728, 23600, 23680, 23664, 23488, 24112, 23680, 23776,
  23680, 23600, 23792, 23728, 23728, 23504, 23296, 23648, 23696, 23616,
  23680, 23648, 23568, 23664, 23712, 23552, 23536, 23648, 23632, 23696,
  23840, 23536, 23744, 23472, 23552, 23680, 23568, 23600, 23648, 23616,
  23776, 23664, 23488, 23712, 23664, 23648, 23808, 23680, 23952, 23680,
  23696, 23616, 23856, 23664, 23200, 23760, 23568, 23728, 23664, 23616,
  23648, 23664, 23648, 23808, 23904, 23184, 23760, 23632, 23584, 23056,
  23712, 23632, 23632, 23616, 23648, 23696, 23488, 23344, 23680, 23600,
  23984, 23680, 23616, 23712, 23472, 23616, 23712, 23680, 23600, 23616,
  23680, 23664, 23872, 23344, 23664, 23680, 23552, 23664, 23920, 23712,
  23680, 23616, 23680, 23664, 22496, 23760, 23632, 23776, 24448, 23648,
  23648, 23664, 23488, 23744, 23472, 23728, 23600, 23680, 23600, 23600,
  23936, 23936, 23552, 23712, 23568, 23600, 23600, 23600, 23648, 23664,
  23552, 23808, 23680, 23680, 23504, 23632, 23744, 23600, 23664, 23808,
  23984, 23488, 23600, 23680, 23728, 23664, 23648, 23664, 23888, 23504,
  23632, 23664, 23664, 23744, 23680, 23712, 23648, 23616, 23360, 23744,
  23520, 23600, 23872, 24016, 23664, 24000, 23632, 23648, 23088, 23600,
  23744, 23696, 23504, 23712, 23664, 23648, 23680, 23296, 23664, 23680,
  23552, 23360, 23328, 23520, 23040, 23584, 23712, 23680, 23568, 23648,
  22960, 23248, 23632, 23632, 23680, 24016, 23312, 23728, 23600, 23728,
  23440, 23632, 23648, 23552, 23728, 23568, 23472, 23616, 23760, 23264,
  23888, 23872, 23568, 23648, 23872, 23632, 23712, 23504, 23648, 24000,
  23008, 23920, 23712, 23552, 23680, 23616, 23664, 23536, 23680, 23504,
  23584, 23600, 23744, 23552, 23488, 23600, 23632, 23680, 23776, 23600,
  23792, 23584, 23552, 23600, 23680, 23712, 23568, 23744, 23664, 23504,
  23472, 23808, 23808, 23552, 23584, 23648, 23648, 23584, 23568, 23696,
  23456, 23552, 23792, 23600, 23040, 23440, 23744, 24176, 23536, 23680,
  23600, 23568, 23616, 23616, 23792, 23696, 23648, 23632, 23552, 23792,
  23856, 23616, 23664, 23216, 23536, 23616, 23472, 23696, 23008, 23728,
  23696, 23552, 23744, 23600, 23536, 24032, 23664, 23056, 23824, 23696,
  23600, 23872, 23728, 23312, 23584, 23680, 23680, 23552, 24176, 23648,
  24064, 23664, 23488, 23616, 23680, 23664, 23648, 23584, 23744, 23632,
  23648, 23584, 23600, 23568, 23616, 23728, 23744, 23648, 23712, 23616,
  23600, 23824, 23632, 23616, 23616, 23680, 23568, 23664, 23552, 23024,
  23760, 24144, 23616, 23680, 23440, 23616, 23360, 23136, 23680, 23648,
  23536, 23568, 23680, 24080, 23840, 23680, 23632, 23536, 23616, 23648,
  23664, 23680, 23648, 23680, 23488, 23488, 23552, 23632, 23600, 23584
)

samples4 <- c(
  23648, 23264, 23600, 23472, 23504, 23280, 23872, 23760, 23840, 23696,
  23680, 23792, 23872, 23440, 23840, 23776, 23424, 23760, 23776, 23664,
  23808, 23728, 23520, 23840, 23376, 23792, 24288, 23760, 23808, 23728,
  23744, 23712, 23728, 23952, 23760, 23712, 23824, 23904, 23568, 23808,
  23632, 24000, 24000, 24016, 23424, 23760, 23824, 23872, 23760, 23744,
  23664, 23792, 23776, 23808, 23616, 23824, 23712, 23472, 23792, 23696,
  23808, 23808, 23616, 23936, 23776, 23776, 23408, 23712, 23712, 23568,
  23424, 24304, 23744, 23728, 23744, 23680, 23792, 23824, 23728, 23648,
  23744, 23728, 23728, 24080, 23840, 23680, 23936, 23600, 23792, 23584,
  23616, 23664, 23664, 23744, 23664, 23712, 23776, 23664, 23600, 23840,
  23648, 23664, 23616, 23632, 23824, 23712, 22784, 23664, 23696, 23712,
  23824, 23712, 23728, 23872, 23664, 23616, 23808, 23696, 23744, 23728,
  23808, 23728, 24096, 23664, 23776, 23408, 23728, 23664, 23728, 23792,
  23760, 23744, 23712, 24160, 23632, 23568, 23760, 23776, 23696, 23712,
  23648, 23808, 23616, 23664, 23248, 23664, 23696, 23680, 23776, 23840,
  23888, 24320, 23536, 23424, 22880, 23744, 23680, 23552, 23664, 23776,
  23712, 23600, 23664, 23680, 23664, 23776, 23632, 23872, 23920, 23680,
  23808, 23648, 23664, 23712, 23664, 23552, 23696, 23552, 23376, 23808,
  23536, 23712, 23728, 23776, 23696, 24176, 23568, 23840, 23424, 23760,
  23760, 23744, 23664, 23888, 23584, 23888, 23600, 24016, 23488, 23808,
  23840, 23712, 23648, 23904, 23808, 23728, 23648, 23632, 23744, 23888,
  23536, 23744, 23632, 23760, 23072, 23680, 23840, 23728, 23584, 23680,
  23696, 23712, 23360, 23632, 23664, 23328, 23760, 23680, 23664, 23760,
  23664, 23360, 23744, 23760, 23760, 23808, 23664, 23712, 24016, 23776,
  24336, 23776, 23776, 24160, 24112, 23648, 23888, 23920, 23776, 24064,
  23760, 23744, 23840, 23728, 23712, 23696, 23696, 23648, 23920, 23648,
  23680, 23408, 23680, 23680, 23680, 23632, 23584, 23664, 23728, 23904,
  23600, 23648, 23776, 23648, 23552, 23744, 23712, 23696, 23680, 23840,
  23696, 23744, 23712, 23744, 23872, 23808, 23680, 23664, 23840, 23728,
  23600, 23616, 23600, 23760, 23072, 23584, 23792, 23664, 24064, 23744,
  23520, 23824, 23744, 23536, 23616, 23872, 24176, 23648, 23376, 23600,
  23648, 23744, 23744, 23664, 23760, 23776, 23696, 23552, 23648, 23728,
  23776, 23760, 23456, 23280, 23536, 24080, 23632, 22848, 23616, 23520,
  23744, 23888, 23632, 23712, 23648, 23552, 23680, 23680, 23696, 23680,
  23424, 23696, 23664, 23344, 23584, 23744, 23680, 23744, 23712, 23776,
  23328, 24352, 23472, 23776, 24240, 23472, 23648, 23680, 23664, 23664,
  23664, 23904, 23616, 23536, 23792, 23808, 23712, 23648, 23840, 23856,
  23648, 23552, 23696, 23536, 23616, 23456, 23680, 23744, 23664, 23712,
  23840, 23696, 23568, 23776, 23680, 23776, 23360, 23968, 23664, 23632,
  23584, 23632, 23728, 23120, 23680, 23712, 23552, 23760, 23840, 23680,
  23536, 23632, 23680, 23888, 24064, 23744, 24096, 23616, 23296, 23632,
  24176, 23632, 23664, 23648, 23824, 23472, 23488, 23712, 23664, 23728,
  23664, 23536, 23728, 23632, 23824, 23680, 23552, 23520, 23456, 23712,
  23424, 23680, 23232, 23696, 23552, 23616, 23648, 23696, 23728, 22768,
  23760, 23616, 23568, 23472, 23728, 23648, 23648, 23712, 24032, 24128,
  23808, 23520, 23680, 23616, 23664, 23600, 23680, 23616, 23632, 23728,
  23648, 23648, 23616, 23664, 23600, 23680, 23760, 23696, 23616, 23792,
  23808, 23552, 23648, 23696, 23792, 23696, 23632, 23792, 23712, 23584,
  23664, 23680, 23680, 23680, 23584, 23328, 23760, 23536, 23664, 23536,
  23744, 23968, 23552, 23824, 23664, 23680, 23744, 23776, 23616, 23968,
  23552, 23520, 23664, 23680, 23760, 23664, 23568, 23520, 24048, 23712,
  23712, 23664, 23696, 23984, 23392, 23680, 23920, 23648, 24256, 23776,
  23696, 23808, 23568, 23584, 23600, 23536, 24240, 23088, 23728, 23680,
  23568, 23472, 23616, 23648, 23696, 23680, 23664, 23648, 23664, 23632,
  23632, 23664, 23600, 23712, 23728, 23664, 23728, 23616, 23664, 23616,
  23328, 23664, 23680, 23488, 23760, 23680, 23744, 23680, 23584, 23824,
  23360, 23408, 24208, 24560, 23664, 23648, 23664, 23680, 23568, 23680,
  23664, 23760, 23712, 23760, 23808, 23680, 23536, 23664, 23696, 23632,
  23680, 23680, 23664, 23648, 23728, 23584, 23552, 23712, 23600, 23680,
  23680, 23728, 23712, 23648, 23568, 23680, 23936, 23632, 23632, 23728,
  23744, 23520, 23168, 23776, 23680, 23680, 23696, 23648, 23696, 23696,
  23536, 23744, 23552, 23520, 23744, 23568, 23232, 23568, 23776, 23808,
  23504, 23632, 23616, 23648, 23600, 23680, 23584, 23856, 23648, 23680,
  23552, 23712, 23872, 23664, 23664, 24192, 23680, 23712, 23536, 23744,
  23664, 23616, 23888, 23616, 23312, 23632, 23616, 23744, 23696, 23696,
  23712, 23712, 23680, 23632, 23648, 23920, 23408, 22976, 23760, 23488,
  23648, 23616, 23392, 23792, 23600, 23472, 23712, 23152, 23584, 23664,
  23600, 23728, 23536, 23568, 23744, 22960, 23664, 23984, 23664, 23536,
  23344, 23376, 24000, 23536, 23920, 23664, 23680, 23520, 23648, 23600,
  23712, 23408, 23600, 23712, 23728, 23616, 23696, 23648, 23632, 23824,
  23664, 24240, 23824, 23712, 23248, 23552, 24000, 23680, 23904, 23648,
  23744, 23664, 23712, 23808, 23952, 23616, 23616, 23664, 23664, 23424,
  23648, 23504, 23472, 23520, 23968, 23968, 23632, 23952, 23744, 23680,
  23696, 23744, 23536, 23696, 23600, 23616, 23664, 23600, 23744, 23616,
  23568, 23664, 23744, 23744, 23664, 23328, 23744, 23680, 23536, 23568,
  23632, 23600, 23696, 23664, 23632, 23776, 23536, 23472, 23584, 23648,
  23472, 23696, 23536, 23792, 23712, 23600, 23648, 23648, 23728, 24000,
  23520, 23696, 23488, 23824, 23712, 23584, 23664, 23728, 23728, 23824,
  23936, 23696, 23664, 23552, 23648, 23712, 23632, 23616, 23680, 23712,
  23632, 23680, 23680, 23536, 23744, 23632, 23648, 23968, 22128, 23664,
  24560, 23520, 23024, 23600, 23680, 23680, 24064, 23200, 23744, 23568,
  23792, 23600, 23760, 23632, 23712, 23680, 23664, 23680, 23728, 23568,
  23888, 23984, 23200, 23744, 23968, 23936, 23728, 23504, 23584, 23616,
  24160, 23744, 23648, 23760, 23696, 23552, 23664, 23600, 23728, 23632,
  23664, 23712, 23568, 23696, 23184, 23552, 23904, 23792, 23696, 23104,
  23664, 23632, 23600, 23104, 23744, 23664, 23600, 23616, 23680, 23648,
  23552, 23504, 23440, 23680, 23248, 23296, 23552, 22256, 24240, 23616,
  23680, 23712, 23552, 23680, 23712, 23680, 23664, 23680, 23984, 23648,
  23552, 23680, 23696, 23712, 23600, 23792, 23600, 23232, 23856, 23600,
  23664, 23984, 24128, 23696, 23664, 23696, 23584, 23504, 23680, 23600,
  23744, 23680, 23664, 23808, 23616, 23568, 23936, 22912, 23760, 23952,
  23808, 24784, 23600, 23808, 23776, 23952, 23712, 23744, 23584, 23616,
  23680, 23696, 23744, 23536, 23552, 23680, 23632, 23648, 23664, 23712,
  23696, 23792, 23680, 23568, 23776, 23680, 23568, 23696, 23680, 23712,
  23408, 23280, 23808, 23648, 23664, 23664, 23680, 23600, 23568, 23552,
  23776, 23680, 23616, 23664, 23584, 23472, 23488, 23856, 23744, 23072,
  23824, 23664, 23616, 23616, 23568, 23760, 23664, 23552, 23648, 22336,
  24208, 23584, 23664, 23712, 23744, 23584, 23696, 23696, 24032, 23664,
  23680, 23584, 23680, 23648, 23936, 23632, 23792, 23616, 23616, 23648,
  23632, 23600, 23600, 24304, 23808, 23648, 23600, 23648, 23584, 23632
)


#############################################

dataname <- "sample4"

ref_voltage <- 3.3

sample_period <- 47.469 * 1e-3
#notes_pos_x <- 10 * 1e-3
notes_pos_x <- sample_period / 4


#rc_value <- 1e6 * 2.2 * 1e-6
rc_value <- 1e6 * 0.1 * 1e-6

delay <- 0.005

#conditions <- "during slow capacitor discharge"
conditions <- "across capacitor"
samples_df <- data.frame(voltage=samples4*ref_voltage/65535.0,
                         time=seq(0.0, sample_period,
                                  length.out=length(samples4)))


model_exp <- nls(voltage ~ I(a * exp((-time - delay) / b)),
                             data=samples_df, start=list(a=samples_df$voltage[1],
                                                         b=rc_value))

model_poly1_pass1 <- nls(voltage ~ I(a * time + b),
                         data=samples_df,
                         start=list(a=0, b=ref_voltage/2))

samples_df$res_poly1_pass1 <- residuals(model_poly1_pass1)

### There's a handful around 50ms out
outlier_s <- 0.050

### Calculate some weights to reduce effect of outliers on nls (s for squares)
### take the distance away from the outlier_s based on first fitted line
### and cap that, scale to 4.99 then cap those values at 4.0
samples_df$w1 <- pmin((outlier_s - pmin(outlier_s,
                                        abs(samples_df$res_poly1_pass1))) * 4.99/outlier_s,
                      4.0)

model_poly1_pass2 <- nls(voltage ~ I(a * time + b),
                         data=samples_df,
                         weights=samples_df$w1,
                         start=list(a=0, b=ref_voltage/2))


### plot graph with points, curve, both lines.


### plot same graph and zoom in on vertical

### TODO - colours are terrible
### yellow points are barely visible
### TODO clean-up legend
### TODO add annotation bottom left with
###    mean, mean(fitted exp()), mean(fitted line), mean(fitted line (weighted))

### Do i care about Q-Q?

###
mean_v = mean(samples_df$voltage)
mean_curve_v = mean(predict(model_exp, list(x=samples_df$time)))
mean_line_v = mean(predict(model_poly1_pass1, list(x=samples_df$time)))
mean_weighted_v = mean(predict(model_poly1_pass2, list(x=samples_df$time)))

### Hacky but I want to use geom_label
max_v = max(samples_df$voltage)
min_v = min(samples_df$voltage)
NApadding = rep(NA, dim(samples_df)[1] - 1)
samples_df$label_x <- c(notes_pos_x, NApadding)
samples_df$label_y <- c(min_v + (max_v - min_v) * 0.15, NApadding)
samples_df$label <- c(sprintf("means            \n samples=%.4f\ncurve=%.4f\nline=%.4f\n  weighted line=%.4f",
                              mean_v, mean_curve_v, mean_line_v, mean_weighted_v),
                      NApadding)

g1 <- ggplot(samples_df, aes(x=time)) +
  ggtitle(paste("P1 pad voltage", conditions)) +
  theme_light(base_size=28) +
  theme(plot.title=element_text(hjust=0.5, size=34),
        legend.position="top", legend.title=element_blank(),
        legend.spacing.x = unit(0.5, 'char'),
        panel.grid.minor.y=element_blank()) +
  scale_x_continuous(labels=function(x) { x * 1000.0 }) +
  labs(x="time (ms)", y="voltage (V)") +
  geom_point(aes(y=voltage,
                 color=cut(samples_df$w1, c(-1, 1, 2, 3, 3.7, 4)),
                 size=5.5 - samples_df$w1)) +
  geom_line(aes(y=predict(model_exp, list(x=time)), color="curve"),
            lwd=6) +
  geom_line(aes(y=predict(model_poly1_pass1, list(x=time)), color="line"),
            linetype="dashed", lwd=3, alpha=0.5) +
  geom_line(aes(y=predict(model_poly1_pass2, list(x=time)), color="weighted"),
            linetype="twodash", lwd=3, alpha=0.5) +
  guides(size=FALSE, linetype=FALSE) +
  scale_color_manual(values=c("(-1,1]" ="red",
                              "(1,2]" = "orangered",
                              "(2,3]" = "orange",
                              "(3,3.7]" = "gray60",
                              "(3.7,4]" = "gray35",
                              
                              "curve" = "grey",
                              "line" = "purple",
                              "weighted" = "green"
                              ),
                     labels=c("curve" = "curve  ", 
                              "line" = "line  ",
                              "weighted" = "weighted line  "),
                     breaks=c("curve", "line", "weighted")) +
  geom_label(aes(y=label_y, x=label_x, label=label),
             hjust=1, size=10, fill="white",
             label.padding = unit(0.65, "char"),
             alpha=0.8
             )


# this shows the line a bit more clearly - also shows the discrete nature of samples
headroom <- 0.000  ### 0mV
g2 <- g1 + coord_cartesian(ylim=c(min(predict(model_poly1_pass1, list(x=samples_df$time)),
                                      predict(model_poly1_pass2, list(x=samples_df$time))
                                      ) - headroom,
                                  max(predict(model_poly1_pass1, list(x=samples_df$time)),
                                      predict(model_poly1_pass2, list(x=samples_df$time))
                                      ) + headroom))
  

st <- shapiro.test(samples_df$res_poly1_pass1)

g3 <-  ggplot(samples_df, aes(x=time)) +
  ggtitle(paste("P1 pad voltage", conditions),
          subtitle="Residuals from first fitted line"
          ) +
  theme_light(base_size=28) +
  theme(plot.title=element_text(hjust=0.5, size=34),
        plot.subtitle=element_text(hjust=0.5, size=28),
        legend.position="top", legend.title=element_blank(),
        legend.spacing.x = unit(0.5, 'char'),
        panel.grid.minor.y=element_blank()) +
  scale_x_continuous(labels=function(x) { x * 1000.0 }) +
  labs(x="time (ms)", y="voltage (mV)") +
  geom_point(aes(y=res_poly1_pass1*1000,
                 color=cut(samples_df$w1, c(-1, 1, 2, 3, 3.7, 4))),
             size=3.5) +
#  guides(size=FALSE, linetype=FALSE) +
  scale_color_manual(values=c("(-1,1]" ="red",
                              "(1,2]" = "orangered",
                              "(2,3]" = "orange",
                              "(3,3.7]" = "gray60",
                              "(3.7,4]" = "gray35",
                              
                              "curve" = "grey",
                              "line" = "purple",
                              "weighted" = "green"
  ),
  labels=c("curve" = "curve  ", 
           "line" = "line  ",
           "weighted" = "weighted line  "),
  breaks=c("curve", "line", "weighted"))


### The joys of working around dynamic scoping for binw
### there's probably a more elegant way of doing this
mkdnorm <- function(binw) {
  lbinw <- binw
  return (function(x) { dnorm(x, mean = mean(samples_df$res_poly1_pass1 * 1000),
        sd = sd(samples_df$res_poly1_pass1 * 1000)) * lbinw * dim(samples_df)[1] })
}

### Histogram time - do several to give option to animate them
### Fixing the x width makes a lot more sense for animation comparison
### but letting the y axis auto-range works well
binwidthds_mv = c(8, 4, 2, 1, 0.5)
ghists <- vector("list", length(binwidthds_mv))
idx <- 1
for (binw in binwidthds_mv) {
  lfunc <- mkdnorm(binw)
  gh <- ggplot(samples_df, aes(x=time)) +
    ggtitle(paste("P1 pad voltage", conditions),
            subtitle="Histogram of residuals from first fitted line"
    ) +
    theme_light(base_size=28) +
    theme(plot.title=element_text(hjust=0.5, size=34),
          plot.subtitle=element_text(hjust=0.5, size=28),
          legend.position="top", legend.title=element_blank(),
          legend.spacing.x = unit(0.5, 'char'),
          panel.grid.minor.y=element_blank()) +
    geom_histogram(aes(res_poly1_pass1*1000, fill="line"),
                   color="black",
                   binwidth=binw) +
    scale_y_continuous(labels=function(x) { print(x) ; sprintf("%04d", x) } ) +
    labs(x="voltage (mV)") +
    stat_function(fun=lfunc, color="blue", lwd=1) +
  #                function(x) { 
  #    dnorm(x, mean = mean(samples_df$res_poly1_pass1 * 1000),
  #          sd = sd(samples_df$res_poly1_pass1 * 1000)) * binw * dim(samples_df)[1] },
  #          color="blue", lwd=1) +
    coord_cartesian(xlim=c(min(samples_df$res_poly1_pass1)*1000,
                           max(samples_df$res_poly1_pass1)*1000))
  ghists[[idx]] <- gh
  idx <- idx + 1
}

binw <- 30

samples_df$wslabel_x <- c(3, NApadding)
min_res <- min(samples_df$res_poly1_pass1)
max_res <- max(samples_df$res_poly1_pass1)
samples_df$wslabel_y <- c(min_res + (max_res - min_res) * 0.15, NApadding) * 1000.0
samples_df$wslabel <- c(sprintf("  %s\n  W=%.3f\n  p-value=%.4e",
                              st$method, st$statistic, st$p.value),
                        NApadding)

g5 <- ggplot(samples_df, aes(sample = res_poly1_pass1*1000, color="line")) +
  ggtitle(paste("P1 pad voltage", conditions),
          subtitle="Q-Q of fitted line residuals vs normal distribution"
  ) +
  theme_light(base_size=28) +
  theme(plot.title=element_text(hjust=0.5, size=34),
        plot.subtitle=element_text(hjust=0.5, size=28),
        legend.position="top", legend.title=element_blank(),
        legend.spacing.x = unit(0.5, 'char'),
        panel.grid.minor.y=element_blank()) +
  stat_qq(shape=21, size=4, show.legend=FALSE) +
  stat_qq(shape=21, size=5, color="black", show.legend=FALSE) +
  stat_qq_line(lwd=2, show.legend=FALSE) +
  geom_label(aes(y=wslabel_y, x=wslabel_x, label=wslabel),
             hjust=1, size=10, color="black", fill="white",
             label.padding = unit(0.65, "char"),
             alpha=0.8
             )

#g1


filebase <- paste0(dataname, "-")

filename <- "samples-fitted-lines"
### Save as 1600x1200 (4:3) png
ggsave(paste(filebase, filename, ".png", sep=""),
       g1,
       dpi=100, height=12, width=16, units="in")


filename <- "samples-fitted-lines-zoom"
### Save as 1600x1200 (4:3) png
ggsave(paste(filebase, filename, ".png", sep=""),
       g2,
       dpi=100, height=12, width=16, units="in")


filename <- "fitted-line-residuals"
### Save as 1600x1200 (4:3) png
ggsave(paste(filebase, filename, ".png", sep=""),
       g3,
       dpi=100, height=12, width=16, units="in")


idx <- 1
for (bins in binwidthds_mv) {
  filename <- sprintf("fitted-line-residuals-histogram-%03d", idx)
  ### Save as 1600x1200 (4:3) png
  ggsave(paste(filebase, filename, ".png", sep=""),
         ghists[[idx]],
         dpi=100, height=12, width=16, units="in")
  idx <- idx + 1
}


filename <- "fitted-line-residuals-qq"
### Save as 1600x1200 (4:3) png
ggsave(paste(filebase, filename, ".png", sep=""),
       g5,
       dpi=100, height=12, width=16, units="in")

